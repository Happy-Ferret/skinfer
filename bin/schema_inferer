#!/usr/bin/env python
# -*- coding: utf-8 -*-

from __future__ import absolute_import, division, print_function

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(__file__)))

import json
from json_schema_merger.draft4_generator import IncompleteDraft4SchemaGenerator
from json_schema_merger.json_schema_merger import merge_schema


def get_samples(args):
    for sample in args.samples:
        with open(sample) as f:
            if args.jsonlines:
                for line in f:
                    yield json.loads(line)
            else:
                yield json.load(f)


def generate_schema_for_sample(sample):
    return IncompleteDraft4SchemaGenerator(sample).to_dict()


def generate_and_merge_schemas(samples):
    merged = generate_schema_for_sample(next(samples))

    for sample in samples:
        merged = merge_schema(merged, generate_schema_for_sample(sample))

    return merged


def run(args):
    try:
        merged = generate_and_merge_schemas(get_samples(args))

        if args.output:
            with open(args.output, 'w') as f:
                json.dump(merged, f, indent=4)
        else:
            print(json.dumps(merged, indent=4))
    except ValueError as e:
        if 'Extra data: line' in e.message:
            print("\nInvalid output: maybe you're missing --jsonlines option?\n"
                  "NOTE: the --jsonlines option must appear before the samples arg\n")
        raise


if '__main__' == __name__:
    import argparse
    parser = argparse.ArgumentParser(
        description="Generates a JSON schema based on samples")

    parser.add_argument('-o', dest='output',
                        help='Write JSON schema to this file')
    parser.add_argument('--jsonlines', action='store_true',
                        help='Assume samples are in JSON lines format')
    parser.add_argument('samples', nargs='+', metavar='SAMPLE',
                        help='JSON data sample files')

    args = parser.parse_args()
    run(args)
